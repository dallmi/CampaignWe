// ============================================================================
// Schema Explorer - Discover data structure for CampaignWe click events
// ============================================================================
// Purpose: Map out the full structure of customDimensions/CustomProps
//          for click_event on gwm-prompt-library.aspx page.
//
// Run each query separately in App Insights > Logs.
// Adjust TimeRange as needed (shorter = faster, longer = more complete).
// ============================================================================


// =========================================================================
// QUERY 1: Full schema map (top-level + CustomProps keys)
// =========================================================================
// Shows every key, a sample value, and the count of events that have it.
// =========================================================================
let TimeRange = 30d;
customEvents
| where timestamp >= ago(TimeRange)
| where name == 'click_event'
| where PageURL endswith 'gwm-prompt-library.aspx'
| extend cd = todynamic(customDimensions)
// --- CustomDimensions keys (Level 1) ---
| extend mainBag = bag_remove_keys(cd, dynamic(["CustomProps"]))
| extend CustomPropsRaw = tostring(cd.CustomProps)
| extend CP = iff(isnotempty(CustomPropsRaw) and CustomPropsRaw startswith "{", todynamic(CustomPropsRaw), dynamic({}))
| extend mainKeys = bag_keys(mainBag)
| extend cpKeys = bag_keys(CP)
// Expand Level 1 keys
| mv-expand mainKey = mainKeys to typeof(string)
| extend L1_value = tostring(mainBag[mainKey])
| extend L1_isNested = isnotempty(L1_value) and L1_value startswith "{"
// Summarize Level 1
| summarize
    EventCount = count(),
    SampleValue = take_any(L1_value),
    IsNestedJSON = take_any(L1_isNested)
    by KeyPath = mainKey
| extend Level = 1, Source = "customDimensions"
| union (
    // --- CustomProps keys (Level 2) ---
    customEvents
    | where timestamp >= ago(TimeRange)
    | where name == 'click_event'
    | where PageURL endswith 'gwm-prompt-library.aspx'
    | extend cd = todynamic(customDimensions)
    | extend CP = iff(
        isnotempty(tostring(cd.CustomProps)) and tostring(cd.CustomProps) startswith "{",
        todynamic(tostring(cd.CustomProps)),
        dynamic({}))
    | extend cpKeys = bag_keys(CP)
    | mv-expand cpKey = cpKeys to typeof(string)
    | extend L2_value = tostring(CP[cpKey])
    | extend L2_isNested = isnotempty(L2_value) and L2_value startswith "{"
    | summarize
        EventCount = count(),
        SampleValue = take_any(L2_value),
        IsNestedJSON = take_any(L2_isNested)
        by KeyPath = strcat("CustomProps.", cpKey)
    | extend Level = 2, Source = "CustomProps"
)
| extend SampleValue = substring(SampleValue, 0, 200)
| project Level, Source, KeyPath, IsNestedJSON, SampleValue, EventCount
| order by Level asc, KeyPath asc


// =========================================================================
// QUERY 2: Quick event count and top-level column check
// =========================================================================
// Verify what top-level columns are available (PageURL, Email, etc.)
// =========================================================================
// customEvents
// | where timestamp >= ago(30d)
// | where name == 'click_event'
// | where PageURL endswith 'gwm-prompt-library.aspx'
// | summarize
//     TotalEvents = count(),
//     UniqueUsers = dcount(user_Id),
//     UniqueSessions = dcount(session_Id),
//     SamplePageURL = take_any(PageURL),
//     SampleEmail = take_any(Email),
//     HasCustomProps = countif(customDimensions has "CustomProps")
// | project TotalEvents, UniqueUsers, UniqueSessions, SamplePageURL, SampleEmail, HasCustomProps


// =========================================================================
// QUERY 3: Sample raw events (see full structure)
// =========================================================================
// customEvents
// | where timestamp >= ago(7d)
// | where name == 'click_event'
// | where PageURL endswith 'gwm-prompt-library.aspx'
// | take 10
