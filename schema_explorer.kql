// ============================================================================
// Schema Explorer - Discover data structure for CampaignWe click events
// ============================================================================
// Run each query separately in App Insights > Logs.
// ============================================================================


// =========================================================================
// QUERY 0A: Does this AppInsights instance have ANY data in last 24h?
// =========================================================================
// customEvents
// | where timestamp >= ago(24h)
// | count


// =========================================================================
// QUERY 0B: Search ALL customDimensions for 'gwm-prompt-library'
// =========================================================================
// customEvents
// | where timestamp >= ago(7d)
// | where customDimensions has 'gwm-prompt-library'
// | take 5


// =========================================================================
// QUERY 0C: Find all keys + values from those 0B rows
// =========================================================================
// No name filter â€” just find any event with gwm-prompt-library in the JSON
// and show ALL key names so we can see the correct field name.
// =========================================================================
customEvents
| where timestamp >= ago(7d)
| where customDimensions has 'gwm-prompt-library'
| extend cd = todynamic(customDimensions)
| extend keys = bag_keys(cd)
| mv-expand key = keys to typeof(string)
| extend val = tostring(cd[key])
| summarize count(), SampleValue = take_any(val) by tostring(key)
| order by count_ desc


// =========================================================================
// QUERY 0D: Original diagnostic (no name filter, PageURL in customDimensions)
// =========================================================================
// customEvents
// | where timestamp >= ago(24h)
// | extend cd = todynamic(customDimensions)
// | where tostring(cd.PageURL) contains 'gwm-prompt-library'
// | summarize count() by name
// | order by count_ desc


// =========================================================================
// QUERY 1: Full schema map (top-level + CustomProps keys)
// =========================================================================
// Shows every key, a sample value, and the count of events that have it.
// Adjust TimeRange and name filter based on QUERY 0 results.
// =========================================================================
// let TimeRange = 30d;
// customEvents
// | where timestamp >= ago(TimeRange)
// | where name == 'click_event'
// | extend cd = todynamic(customDimensions)
// | where tostring(cd.PageURL) contains 'gwm-prompt-library.aspx'
// // --- CustomDimensions keys (Level 1) ---
// | extend mainBag = bag_remove_keys(cd, dynamic(["CustomProps"]))
// | extend CustomPropsRaw = tostring(cd.CustomProps)
// | extend CP = iff(isnotempty(CustomPropsRaw) and CustomPropsRaw startswith "{", todynamic(CustomPropsRaw), dynamic({}))
// | extend mainKeys = bag_keys(mainBag)
// | extend cpKeys = bag_keys(CP)
// // Expand Level 1 keys
// | mv-expand mainKey = mainKeys to typeof(string)
// | extend L1_value = tostring(mainBag[mainKey])
// | extend L1_isNested = isnotempty(L1_value) and L1_value startswith "{"
// // Summarize Level 1
// | summarize
//     EventCount = count(),
//     SampleValue = take_any(L1_value),
//     IsNestedJSON = take_any(L1_isNested)
//     by KeyPath = mainKey
// | extend Level = 1, Source = "customDimensions"
// | union (
//     // --- CustomProps keys (Level 2) ---
//     customEvents
//     | where timestamp >= ago(TimeRange)
//     | where name == 'click_event'
//     | extend cd = todynamic(customDimensions)
//     | where tostring(cd.PageURL) contains 'gwm-prompt-library.aspx'
//     | extend CP = iff(
//         isnotempty(tostring(cd.CustomProps)) and tostring(cd.CustomProps) startswith "{",
//         todynamic(tostring(cd.CustomProps)),
//         dynamic({}))
//     | extend cpKeys = bag_keys(CP)
//     | mv-expand cpKey = cpKeys to typeof(string)
//     | extend L2_value = tostring(CP[cpKey])
//     | extend L2_isNested = isnotempty(L2_value) and L2_value startswith "{"
//     | summarize
//         EventCount = count(),
//         SampleValue = take_any(L2_value),
//         IsNestedJSON = take_any(L2_isNested)
//         by KeyPath = strcat("CustomProps.", cpKey)
//     | extend Level = 2, Source = "CustomProps"
// )
// | extend SampleValue = substring(SampleValue, 0, 200)
// | project Level, Source, KeyPath, IsNestedJSON, SampleValue, EventCount
// | order by Level asc, KeyPath asc


// =========================================================================
// QUERY 2: Sample raw events (see full structure)
// =========================================================================
// customEvents
// | where timestamp >= ago(7d)
// | where name == 'click_event'
// | extend cd = todynamic(customDimensions)
// | where tostring(cd.PageURL) contains 'gwm-prompt-library.aspx'
// | take 10
